import { vi, it, expect, afterEach } from "vitest"
import {
  MdContest,
  getActiveCantinaContests,
  getActiveContests,
} from "./getActive.js"
import { parseMd } from "./parseContest.js"

let contestMd =
  "[How it works](/welcome#how-it-works)[Services](/welcome#services)[FAQ](/welcome#faq)[Competitions](/competitions)\n\n[Sign in](/login)\n\n[How it works](/welcome#how-it-works)[Services](/welcome#services)[FAQ](/welcome#faq)[Competitions](/competitions)[Sign in](/login)\n\n1. [Competitions](/competitions)\n2. metamorpho-and-periphery\n\n![profile image](https://imagedelivery.net/wtv4_V7VzVsxpAFaxzmpbw/49be999a-a44f-4d2e-de7c-ea3a11173300/public)\n\nMorpho \\- metamorpho-and-periphery\n\n# Metamorpho and Periphery Competition\n\nMorpho Labs has teamed up with Cantina for the inaugural public security review competition hosted on their new platform by security researchers for security researchers.\n\nThe competition at a glance:\n\n* November 16th 10:00 UTC to December 7th 10:00 UTC\n* $100k total prize pool.\n\n### What is Morpho Blue and MetaMorpho\n\nMorpho Blue and MetaMorpho form part of the vision to rebuild decentralized lending in layers, with MetaMorpho enabling any lending experience to be rebuilt on a shared and immutable base layer: Morpho Blue.\n\nMorpho Blue is a trustless lending primitive that offers unparalleled efficiency and flexibility. It enables the creation of isolated lending markets by specifying any loan asset, any collateral asset, a liquidation LTV (LLTV), an oracle, and an interest rate model.\n\nMetaMorpho is a protocol for lending vaults built on Morpho Blue. Anyone can create a vault that allocates to multiple Morpho Blue markets. Each vault is curated to provide suppliers with tailored risk exposures, better yields, and greater transparency.\n\nVisit the [docs](https://www.notion.so/00ff8194791045deb522821be46abbdc?pvs=21) for a complete project overview.\n\n### Prize distribution and scoring\n\nThe prize distribution works as follows:\n\n* Security reviewers will score points for each finding.\n* Prizes are distributed proportionally to the number of points scored.\n* A High Severity is worth 10 points, and a Medium Severity 3 points.\n* Duplicate findings will be resolved using a scoring formula that incentivizes unique findings.\n* Duplicate findings will be resolved using the following scoring formula that incentivizes unique findings:  \n   * Each duplicate finding will be scaled down by `0.9n−1/n0.9^{n - 1} / n0.9n−1/n`, where `nnn` is the # of duplicates.\n* 10% of the prize pot is reserved for Low Severity or informational findings. These reports are judged based on quality and researchers are then ranked from 1st to 5th for the purpose of prize allocation:  \n   * 1st: $5k  \n   * 2nd: $2.5k  \n   * 3rd: $1.25k  \n   * 4th: $625  \n   * 5th: $625\n\n## Scope\n\nCheck out the previously recorded read through of the repos for both competitions on [cantina twitter](https://twitter.com/cantinaxyz/status/1722658075226800296).\n\n### Morpho Blue IRM\n\n* Repository: [morpho-org/morpho-blue-irm](https://github.com/morpho-org/morpho-blue-irm/tree/c2b1732fc332d20a001ca505aea76bd475e95ef1)\n* Commit: c2b1732fc332d20a001ca505aea76bd475e95ef1\n* Total LOC: 134\n* Files: all files in `src`\n\n| File                        | blank  | comment | code    |\n| --------------------------- | ------ | ------- | ------- |\n| src/SpeedJumpIrm.sol        | 27     | 45      | 87      |\n| src/libraries/MathLib.sol   | 10     | 16      | 29      |\n| src/libraries/ErrorsLib.sol | 6      | 11      | 9       |\n| src/libraries/UtilsLib.sol  | 1      | 9       | 9       |\n| **SUM:**                    | **44** | **81**  | **134** |\n\n### Morpho Blue Oracles\n\n* Repository: [morpho-org/morpho-blue-oracles](https://github.com/morpho-org/morpho-blue-oracles/tree/d351d3e59b207729d785ec568ed0d2ee24498189)\n* Commit: d351d3e59b207729d785ec568ed0d2ee24498189\n* Total LOC: 92\n* Files: all files in `src`\n\n| File                                     | blank  | comment | code   |\n| ---------------------------------------- | ------ | ------- | ------ |\n| src/ChainlinkOracle.sol                  | 9      | 46      | 46     |\n| src/libraries/ChainlinkDataFeedLib.sol   | 7      | 13      | 15     |\n| src/interfaces/AggregatorV3Interface.sol | 5      | 3       | 14     |\n| src/libraries/VaultLib.sol               | 3      | 7       | 8      |\n| src/libraries/ErrorsLib.sol              | 2      | 7       | 5      |\n| src/interfaces/IERC4626.sol              | 1      | 4       | 4      |\n| **SUM:**                                 | **27** | **77**  | **92** |\n\n## MetaMorpho\n\n* Repository: [morpho-org/metamorpho](https://github.com/morpho-org/metamorpho/tree/f4e2574029743088a8800149593fa997ab66f0f8)\n* Commit: f4e2574029743088a8800149593fa997ab66f0f8\n* Total LOC: 642\n* Files: all files in `src` except the `mocks` folder\n\n| File                                   | blank   | comment | code    |\n| -------------------------------------- | ------- | ------- | ------- |\n| src/MetaMorpho.sol                     | 202     | 183     | 477     |\n| src/interfaces/IMetaMorpho.sol         | 17      | 11      | 65      |\n| src/libraries/EventsLib.sol            | 22      | 34      | 37      |\n| src/MetaMorphoFactory.sol              | 13      | 20      | 26      |\n| src/libraries/ErrorsLib.sol            | 21      | 26      | 24      |\n| src/libraries/ConstantsLib.sol         | 5       | 10      | 8       |\n| src/interfaces/IMorphoMarketParams.sol | 2       | 1       | 5       |\n| **SUM:**                               | **282** | **285** | **642** |\n\n## Morpho Blue Bundlers\n\n* Repository: [morpho-org/morpho-blue-bundlers](https://github.com/morpho-org/morpho-blue-bundlers/tree/5099e5fef9a82a500b875eb81b90c2deca1de243)\n* Commit: 5099e5fef9a82a500b875eb81b90c2deca1de243\n* Total LOC: 983\n* Files: all files in `src` except the `mocks` and `goerli` folders\n\n| File                                                      | blank   | comment  | code    |\n| --------------------------------------------------------- | ------- | -------- | ------- |\n| src/migration/interfaces/IAaveV3.sol                      | 41      | 356      | 126     |\n| src/MorphoBundler.sol                                     | 39      | 84       | 112     |\n| src/migration/interfaces/IAaveV2.sol                      | 24      | 157      | 80      |\n| src/migration/interfaces/IAaveV30ptimizer.sol             | 12      | 3        | 72      |\n| src/ERC4626Bundler.sol                                    | 27      | 45       | 47      |\n| src/migration/CompoundV3MigrationBundler.sol              | 16      | 38       | 41      |\n| src/migration/interfaces/ICompoundV3.sol                  | 16      | 1        | 36      |\n| src/migration/AaveV30ptimizerMigrationBundler.sol         | 15      | 42       | 35      |\n| src/migration/CompoundV2MigrationBundler.sol              | 20      | 28       | 34      |\n| src/StEthBundler.sol                                      | 20      | 26       | 33      |\n| src/BaseBundler.sol                                       | 17      | 26       | 32      |\n| src/TransferBundler.sol                                   | 15      | 26       | 28      |\n| src/WNativeBundler.sol                                    | 17      | 24       | 26      |\n| src/interfaces/IWstEth.sol                                | 2       | 1        | 25      |\n| src/UrdBundler.sol                                        | 5       | 14       | 22      |\n| src/ethereum/EthereumBundler.sol                          | 4       | 6        | 22      |\n| src/Permit2Bundler.sol                                    | 8       | 13       | 20      |\n| src/migration/AaveV2MigrationBundler.sol                  | 13      | 25       | 20      |\n| src/migration/AaveV3MigrationBundler.sol                  | 13      | 24       | 20      |\n| src/migration/MigrationBundler.sol                        | 7       | 9        | 16      |\n| src/ethereum/EthereumPermitBundler.sol                    | 4       | 15       | 15      |\n| src/PermitBundler.sol                                     | 3       | 16       | 14      |\n| src/ethereum/interfaces/IDaiPermit.sol                    | 2       | 10       | 14      |\n| src/interfaces/IMorphoBundler.sol                         | 2       | 5        | 13      |\n| src/libraries/ErrorsLib.sol                               | 12      | 17       | 13      |\n| src/migration/interfaces/ICToken.sol                      | 8       | 1        | 11      |\n| src/migration/interfaces/ICEth.sol                        | 7       | 1        | 10      |\n| src/interfaces/IStEth.sol                                 | 5       | 1        | 8       |\n| src/ethereum/libraries/MainnetLib.sol                     | 4       | 5        | 7       |\n| src/ethereum/migration/AaveV2EthereumMigrationBundler.sol | 4       | 6        | 7       |\n| src/interfaces/IWNative.sol                               | 1       | 1        | 7       |\n| src/ethereum/EthereumStEthBundler.sol                     | 4       | 6        | 6       |\n| src/interfaces/IMulticall.sol                             | 1       | 7        | 4       |\n| src/migration/interfaces/IComptroller.sol                 | 1       | 1        | 4       |\n| src/libraries/ConstantsLib.sol                            | 2       | 3        | 3       |\n| **SUM:**                                                  | **391** | **1043** | **983** |\n\n## Universal Rewards Distributor\n\n* Repository: [morpho-org/universal-rewards-distributor](https://github.com/morpho-org/universal-rewards-distributor/tree/94a604c926a4878661f38a8f3b05cd61c95c7b84)\n* Commit: 94a604c926a4878661f38a8f3b05cd61c95c7b84\n* Total LOC: 181\n* Files: all files in `src`\n\n| File                                            | blank  | comment | code    |\n| ----------------------------------------------- | ------ | ------- | ------- |\n| src/UniversalRewardsDistributor.sol             | 48     | 65      | 100     |\n| src/interfaces/IUniversalRewardsDistributor.sol | 6      | 9       | 28      |\n| src/UrdFactory.sol                              | 8      | 14      | 24      |\n| src/libraries/EventsLib.sol                     | 8      | 31      | 19      |\n| src/libraries/ErrorsLib.sol                     | 7      | 12      | 10      |\n| **SUM:**                                        | **77** | **131** | **181** |\n\n## ERC20Permissioned\n\n* Repository: [morpho-org/erc20-permissioned](https://github.com/morpho-org/erc20-permissioned/tree/5176577690da4611a2c4de7a2591d431458ffb27)\n* Commit: 5176577690da4611a2c4de7a2591d431458ffb27\n* Total LOC: 55\n* Files: all files in `src`\n\n| File                          | blank | comment | code |\n| ----------------------------- | ----- | ------- | ---- |\n| src/ERC20PermissionedBase.sol | 25    | 33      | 55   |\n\n## Out of Scope issues\n\nAny findings on the previous review from OpenZeppelin / Cantina Managed review will be considered out of scope.\n\nOn top of that, automated findings from [4nalyzer](https://gist.github.com/hrkrshnn/9bd4d0ee06d66c2f75db5044cb5fd399) will also be considered out of scope.\n\n## Summary\n\nStatus\n\nLive\n\nTotal reward:\n\n$100,000 USDC\n\nStart date:\n\n16 Nov 2023 12:00am UTC\n\nEnd date:\n\n7 Dec 2023 12:00am UTC\n\nYou need to be logged in as a researcher in order to join.\n\nJoin competition\n\n© 2023 Cantina. All rights reserved"

let mdContest: MdContest = {
  id: "8409a0ce-6c21-4cc9-8ef2-bd77ce7425af",
  name: "morpho-metamorpho-and-periphery",
  start_date: 1637059200000,
  end_date: 1638864000000,
  prize: "$100,000 USDC",
}

it("parses", () => {
  let contest = parseMd(mdContest, contestMd)
  expect(contest.modules.length).toBe(58)
  expect(contest.doc_urls?.at(0)).toBe(
    "https://www.notion.so/00ff8194791045deb522821be46abbdc?pvs=21"
  )
})
